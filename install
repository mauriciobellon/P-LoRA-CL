#!/bin/bash

# Development Installer
# This script sets up the complete development environment
# Only needs to be run once when the project is first cloned

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
cd "$SCRIPT_DIR"

readonly RED='\033[0;31m'
readonly GREEN='\033[0;32m'
readonly YELLOW='\033[1;33m'
readonly BLUE='\033[0;34m'
readonly CYAN='\033[0;36m'
readonly BOLD='\033[1m'
readonly NC='\033[0m'

log_info() { echo -e "${CYAN}[INFO]${NC} $1"; }
log_success() { echo -e "${GREEN}[SUCCESS]${NC} $1"; }
log_warning() { echo -e "${YELLOW}[WARNING]${NC} $1"; }
log_error() { echo -e "${RED}[ERROR]${NC} $1"; }
log_step() { echo -e "${BOLD}${BLUE}=== $1 ===${NC}"; }

echo -e "${BOLD}${CYAN}Development Environment Installer${NC}"
echo "This script will install all required dependencies for development"
echo ""

# =============================================================================
# Package Management Abstraction
# =============================================================================

run_command() {
    local cmd=("$@")

    if ! "${cmd[@]}"; then
        log_error "Command failed: ${cmd[*]}"
        return 1
    fi
    return 0
}

update_package_index() {
    log_info "Updating package index..."
    run_command sudo apt-get update >/dev/null 2>&1
}

install_packages() {
    local packages=("$@")
    log_info "Installing packages: ${packages[*]}"
    run_command sudo apt-get install -y "${packages[@]}"
}

check_command() {
    local cmd="$1"
    command -v "$cmd" >/dev/null 2>&1
}

# =============================================================================
# Core Dependencies Installation
# =============================================================================

install_core_dependencies() {
    log_step "Installing Core Dependencies"

    update_package_index

    local core_packages=(
        "ca-certificates" "curl" "gnupg" "lsb-release" "git"
        "build-essential" "pkg-config" "software-properties-common"
    )

    install_packages "${core_packages[@]}"
    log_success "Core dependencies installed"
}

# =============================================================================
# UV Package Manager Installation
# =============================================================================

check_uv() {
    if check_command uv; then
        return 0
    fi

    local uv_locations=(
        "$HOME/.local/bin/uv"
        "$HOME/.cargo/bin/uv"
        "/usr/local/bin/uv"
    )

    for location in "${uv_locations[@]}"; do
        if [ -x "$location" ]; then
            local bin_dir="$(dirname "$location")"
            if [[ ":$PATH:" != *":$bin_dir:"* ]]; then
                export PATH="$bin_dir:$PATH"
            fi
            return 0
        fi
    done
    return 1
}

install_uv() {
    log_step "Installing UV Package Manager"

    if check_uv; then
        log_success "uv already installed ($(uv --version))"
        return 0
    fi

    log_info "Installing uv..."
    if curl -LsSf https://astral.sh/uv/install.sh | sh; then
        log_info "uv download completed"
    else
        log_error "uv installation script failed"
        return 1
    fi

    if [ -f "$HOME/.cargo/env" ]; then
        source "$HOME/.cargo/env"
    fi

    if check_uv; then
        log_success "uv installed successfully ($(uv --version))"
        return 0
    else
        log_error "uv installation verification failed"
        return 1
    fi
}

# =============================================================================
# AutoEnv Installation
# =============================================================================

install_autoenv() {
    log_step "Installing AutoEnv"

    if [ -d "$HOME/.autoenv" ]; then
        log_success "autoenv already installed"
        return 0
    fi

    log_info "Cloning autoenv repository..."
    if git clone 'https://github.com/hyperupcall/autoenv' ~/.autoenv >/dev/null 2>&1; then
        log_success "Autoenv cloned successfully"
    else
        log_error "Failed to clone autoenv repository"
        return 1
    fi

    local shell_config="$HOME/.bashrc"
    if ! grep -q "autoenv/activate.sh" "$shell_config" 2>/dev/null; then
        {
            echo ''
            echo '# AutoEnv configuration'
            echo 'export AUTOENV_ASSUME_YES="true"'
            echo 'export AUTOENV_ENABLE_LEAVE="true"'
            echo 'export AUTOENV_ENV_FILENAME="autoenv"'
            echo 'source ~/.autoenv/activate.sh'
        } >> "$shell_config"
        log_success "Added autoenv to $shell_config"
    else
        log_success "Autoenv already configured in $shell_config"
    fi
}

# =============================================================================
# Python Environment Setup
# =============================================================================

setup_python_environment() {
    log_step "Setting up Python Environment"

    if [ ! -f "pyproject.toml" ]; then
        log_error "No pyproject.toml found - cannot sync dependencies"
        return 1
    fi

    log_info "Running uv sync..."
    if uv sync; then
        log_success "Python dependencies installed successfully"
    else
        log_error "uv sync failed"
        return 1
    fi
}

# =============================================================================
# Main Installation Flow
# =============================================================================

main() {
    log_step "Starting Development Environment Setup"

    install_core_dependencies

    install_uv

    install_autoenv

    setup_python_environment

    log_step "Installation Complete!"

    echo ""
    log_success "Development environment installed successfully!"
    echo ""
    echo -e "${BOLD}Next steps:${NC}"
    echo "2. Navigate back to this directory to automatically activate the environment"
    echo "3. Use 'uv run' commands as documented in README.md"
    echo ""
    echo -e "${CYAN}The environment will automatically activate when you enter this directory.${NC}"
}

main "$@"
